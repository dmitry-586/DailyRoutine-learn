# ╨ô╨╗╨░╨▓╨░ 54. TanStack Query: ╨╝╤â╤é╨░╤å╨╕╨╕, invalidation, optimistic updates, prefetch ╨╕ infinite queries

╨£╤â╤é╨░╤å╨╕╨╕, ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Å, optimistic updates ╨╕ prefetch ΓÇö ╨┐╤Ç╨╛╨┤╨▓╨╕╨╜╤â╤é╤ï╨╡ ╨▓╨╛╨╖╨╝╨╛╨╢╨╜╨╛╤ü╤é╨╕ TanStack Query ╨┤╨╗╤Å ╤ì╤ä╤ä╨╡╨║╤é╨╕╨▓╨╜╨╛╨╣ ╤Ç╨░╨▒╨╛╤é╤ï ╤ü ╨╕╨╖╨╝╨╡╨╜╨╡╨╜╨╕╤Å╨╝╨╕ ╨┤╨░╨╜╨╜╤ï╤à ╨╕ ╨╛╨┐╤é╨╕╨╝╨╕╨╖╨░╤å╨╕╨╕ UX.

---

## 54.1. useMutation: ╨╕╨╖╨╝╨╡╨╜╨╡╨╜╨╕╨╡ ╨┤╨░╨╜╨╜╤ï╤à

`useMutation` ΓÇö ╤à╤â╨║ ╨┤╨╗╤Å ╨╛╨┐╨╡╤Ç╨░╤å╨╕╨╣, ╨╕╨╖╨╝╨╡╨╜╤Å╤Ä╤ë╨╕╤à ╨┤╨░╨╜╨╜╤ï╨╡ ╨╜╨░ ╤ü╨╡╤Ç╨▓╨╡╤Ç╨╡ (POST, PUT, PATCH, DELETE).

**╨Ü╨╗╤Ä╤ç╨╡╨▓╤ï╨╡ ╨╛╤é╨╗╨╕╤ç╨╕╤Å ╨╛╤é useQuery:**

- ╨¥╨╡ ╨▓╤ï╨┐╨╛╨╗╨╜╤Å╨╡╤é╤ü╤Å ╨░╨▓╤é╨╛╨╝╨░╤é╨╕╤ç╨╡╤ü╨║╨╕ ΓÇö ╨╜╤â╨╢╨╜╨╛ ╨▓╤ï╨╖╨▓╨░╤é╤î `mutate()`
- ╨¥╨╡ ╨║╨╡╤ê╨╕╤Ç╤â╨╡╤é╤ü╤Å ΓÇö ╨║╨░╨╢╨┤╤ï╨╣ ╨▓╤ï╨╖╨╛╨▓ ╨╛╤é╨┐╤Ç╨░╨▓╨╗╤Å╨╡╤é ╨╖╨░╨┐╤Ç╨╛╤ü
- ╨ÿ╨╝╨╡╨╡╤é ╨║╨╛╨╗╨▒╤ì╨║╨╕ `onSuccess`, `onError`, `onSettled` ╨┤╨╗╤Å ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨╕ ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é╨░

**╨₧╤ü╨╜╨╛╨▓╨╜╤ï╨╡ ╤ü╨▓╨╛╨╣╤ü╤é╨▓╨░:**

- **mutate(data)** ΓÇö ╨╖╨░╨┐╤â╤ü╨║╨░╨╡╤é ╨╝╤â╤é╨░╤å╨╕╤Ä (fire-and-forget, ╨╜╨╡ ╤é╤Ç╨╡╨▒╤â╨╡╤é try/catch)
- **mutateAsync(data)** ΓÇö ╨▓╨╛╨╖╨▓╤Ç╨░╤ë╨░╨╡╤é Promise (╨┤╨╗╤Å await, ╤é╤Ç╨╡╨▒╤â╨╡╤é try/catch)
- **isPending** ΓÇö ╨╝╤â╤é╨░╤å╨╕╤Å ╨▓╤ï╨┐╨╛╨╗╨╜╤Å╨╡╤é╤ü╤Å
- **isSuccess/isError** ΓÇö ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é ╨╝╤â╤é╨░╤å╨╕╨╕
- **reset()** ΓÇö ╤ü╨▒╤Ç╨╛╤ü ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╤Å

**╨á╨╡╨║╨╛╨╝╨╡╨╜╨┤╨░╤å╨╕╤Å:** ╨╕╤ü╨┐╨╛╨╗╤î╨╖╤â╨╣╤é╨╡ `mutate` ╨▓ ╨▒╨╛╨╗╤î╤ê╨╕╨╜╤ü╤é╨▓╨╡ ╤ü╨╗╤â╤ç╨░╨╡╨▓, ╤é╨░╨║ ╨║╨░╨║ ╨╛╨╜ ╨╜╨╡ ╤é╤Ç╨╡╨▒╤â╨╡╤é ╤Ç╤â╤ç╨╜╨╛╨│╨╛ `try/catch` ΓÇö ╨╛╤ê╨╕╨▒╨║╨╕ ╨╛╨▒╤Ç╨░╨▒╨░╤é╤ï╨▓╨░╤Ä╤é╤ü╤Å ╤ç╨╡╤Ç╨╡╨╖ `onError`. `mutateAsync` ╨╜╤â╨╢╨╡╨╜ ╤é╨╛╨╗╤î╨║╨╛ ╨║╨╛╨│╨┤╨░ ╤é╤Ç╨╡╨▒╤â╨╡╤é╤ü╤Å ╤ü╨╕╨╜╤à╤Ç╨╛╨╜╨╜╨░╤Å ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨░ ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é╨░.

**╨ƒ╨╛╤ü╨╗╨╡ ╤â╤ü╨┐╨╡╤ê╨╜╨╛╨╣ ╨╝╤â╤é╨░╤å╨╕╨╕** ╨╛╨▒╤ï╤ç╨╜╨╛ ╨╜╤â╨╢╨╜╨╛ ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨╕╤Ç╨╛╨▓╨░╤é╤î ╤ü╨▓╤Å╨╖╨░╨╜╨╜╤ï╨╡ ╨╖╨░╨┐╤Ç╨╛╤ü╤ï ╤ç╨╡╤Ç╨╡╨╖ `queryClient.invalidateQueries()`, ╤ç╤é╨╛╨▒╤ï UI ╨╛╨▒╨╜╨╛╨▓╨╕╨╗╤ü╤Å.

---

## 54.2. Invalidation (╨╕╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Å)

╨ÿ╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Å ╨┐╨╛╨╝╨╡╤ç╨░╨╡╤é ╨┤╨░╨╜╨╜╤ï╨╡ ╨║╨░╨║ ╤â╤ü╤é╨░╤Ç╨╡╨▓╤ê╨╕╨╡ ╨╕ ╨▓╤ï╨╖╤ï╨▓╨░╨╡╤é ╨╕╤à ╨░╨▓╤é╨╛╨╝╨░╤é╨╕╤ç╨╡╤ü╨║╨╛╨╡ ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡.

**╨ù╨░╤ç╨╡╨╝ ╨╜╤â╨╢╨╜╨░ ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Å?**

╨ƒ╨╛╤ü╨╗╨╡ ╨╝╤â╤é╨░╤å╨╕╨╕ (╤ü╨╛╨╖╨┤╨░╨╜╨╕╨╡, ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡, ╤â╨┤╨░╨╗╨╡╨╜╨╕╨╡) ╨║╨╡╤ê╨╕╤Ç╨╛╨▓╨░╨╜╨╜╤ï╨╡ ╨┤╨░╨╜╨╜╤ï╨╡ ╤â╤ü╤é╨░╤Ç╨╡╨╗╨╕. ╨ÿ╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Å ╤ü╨╛╨╛╨▒╤ë╨░╨╡╤é TanStack Query: ┬½╤ì╤é╨╕ ╨┤╨░╨╜╨╜╤ï╨╡ ╨╜╤â╨╢╨╜╨╛ ╨╛╨▒╨╜╨╛╨▓╨╕╤é╤î┬╗.

**╨í╤é╤Ç╨░╤é╨╡╨│╨╕╨╕ ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╨╕:**

1. **╨¿╨╕╤Ç╨╛╨║╨░╤Å** ΓÇö `invalidateQueries({ queryKey: ['users'] })` ╨╛╨▒╨╜╨╛╨▓╨╕╤é ╨Æ╨í╨ò ╨╖╨░╨┐╤Ç╨╛╤ü╤ï ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╨╡╨╣
2. **╨ó╨╛╤ç╨╡╤ç╨╜╨░╤Å** ΓÇö `invalidateQueries({ queryKey: ['users', 'detail', 123] })` ╨╛╨▒╨╜╨╛╨▓╨╕╤é ╤é╨╛╨╗╤î╨║╨╛ ╨║╨╛╨╜╨║╤Ç╨╡╤é╨╜╨╛╨│╨╛ ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤Å
3. **╨í ╨┐╤Ç╨╡╨┤╨╕╨║╨░╤é╨╛╨╝** ΓÇö `predicate: (query) => ...` ╨┤╨╗╤Å ╤ü╨╗╨╛╨╢╨╜╨╛╨╣ ╨╗╨╛╨│╨╕╨║╨╕ ╨▓╤ï╨▒╨╛╤Ç╨░

**╨á╨╡╨║╨╛╨╝╨╡╨╜╨┤╨░╤å╨╕╤Å:** ╨╕╤ü╨┐╨╛╨╗╤î╨╖╤â╨╣╤é╨╡ ╤é╨╛╤ç╨╡╤ç╨╜╤â╤Ä ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨░╤å╨╕╤Ä. ╨¡╤é╨╛ ╤ü╨╛╤à╤Ç╨░╨╜╤Å╨╡╤é ╨╜╨╡╨╕╨╖╨╝╨╡╨╜╨╡╨╜╨╜╤ï╨╡ ╨┤╨░╨╜╨╜╤ï╨╡ ╨▓ ╨║╨╡╤ê╨╡ ╨╕ ╤ü╨╛╨║╤Ç╨░╤ë╨░╨╡╤é ╨║╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛ ╨╖╨░╨┐╤Ç╨╛╤ü╨╛╨▓.

**╨ó╨╕╨┐╨╕╤ç╨╜╤ï╨╣ ╨┐╨░╤é╤é╨╡╤Ç╨╜:** ╨▓ `onSuccess` ╨╝╤â╤é╨░╤å╨╕╨╕ ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨╕╤Ç╤â╨╣╤é╨╡ ╤ü╨▓╤Å╨╖╨░╨╜╨╜╤ï╨╡ ╤ü╨┐╨╕╤ü╨║╨╕ ╨╕ ╨║╨╛╨╜╨║╤Ç╨╡╤é╨╜╤â╤Ä ╤ü╤â╤ë╨╜╨╛╤ü╤é╤î.

---

## 54.3. Optimistic Updates

Optimistic updates ΓÇö ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡ UI **╨┤╨╛** ╨┐╨╛╨╗╤â╤ç╨╡╨╜╨╕╤Å ╨╛╤é╨▓╨╡╤é╨░ ╨╛╤é ╤ü╨╡╤Ç╨▓╨╡╤Ç╨░. ╨ƒ╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤î ╨▓╨╕╨┤╨╕╤é ╨╝╨│╨╜╨╛╨▓╨╡╨╜╨╜╤ï╨╣ ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é, ╨░ ╨╡╤ü╨╗╨╕ ╨╖╨░╨┐╤Ç╨╛╤ü ╤â╨┐╨░╨┤╤æ╤é ΓÇö ╨╛╤é╨║╨░╤é ╨║ ╨┐╤Ç╨╡╨┤╤ï╨┤╤â╤ë╨╡╨╝╤â ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╤Ä.

**╨Ü╨╛╨│╨┤╨░ ╨╕╤ü╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╤î:**

- ╨ƒ╤Ç╨╛╤ü╤é╤ï╨╡ ╨╛╨┐╨╡╤Ç╨░╤å╨╕╨╕ ╤ü ╨▓╤ï╤ü╨╛╨║╨╛╨╣ ╨▓╨╡╤Ç╨╛╤Å╤é╨╜╨╛╤ü╤é╤î╤Ä ╤â╤ü╨┐╨╡╤à╨░ (╨╗╨░╨╣╨║, ╨┐╨╡╤Ç╨╡╨║╨╗╤Ä╤ç╨╡╨╜╨╕╨╡ ╤ü╤é╨░╤é╤â╤ü╨░)
- ╨Ü╤Ç╨╕╤é╨╕╤ç╨╜╨╛ ╨▒╤ï╤ü╤é╤Ç╤ï╨╣ ╨╛╤é╨║╨╗╨╕╨║ UI
- ╨£╨╛╨╢╨╜╨╛ ╨╗╨╡╨│╨║╨╛ ╨╛╤é╨║╨░╤é╨╕╤é╤î ╨╕╨╖╨╝╨╡╨╜╨╡╨╜╨╕╤Å

**╨É╨╗╨│╨╛╤Ç╨╕╤é╨╝ ╤Ç╨╡╨░╨╗╨╕╨╖╨░╤å╨╕╨╕:**

1. **onMutate** ΓÇö ╨╛╤é╨╝╨╡╨╜╤Å╨╡╨╝ ╨░╨║╤é╨╕╨▓╨╜╤ï╨╡ ╨╖╨░╨┐╤Ç╨╛╤ü╤ï, ╤ü╨╛╤à╤Ç╨░╨╜╤Å╨╡╨╝ ╨┐╤Ç╨╡╨┤╤ï╨┤╤â╤ë╨╡╨╡ ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╨╡, ╨╛╨▒╨╜╨╛╨▓╨╗╤Å╨╡╨╝ ╨║╨╡╤ê ╨╛╨┐╤é╨╕╨╝╨╕╤ü╤é╨╕╤ç╨╜╨╛
2. **onError** ΓÇö ╨╛╤é╨║╨░╤é╤ï╨▓╨░╨╡╨╝ ╨║ ╤ü╨╛╤à╤Ç╨░╨╜╤æ╨╜╨╜╨╛╨╝╤â ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╤Ä ╨┐╤Ç╨╕ ╨╛╤ê╨╕╨▒╨║╨╡
3. **onSettled** ΓÇö ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨╕╤Ç╤â╨╡╨╝ ╨┤╨░╨╜╨╜╤ï╨╡ ╨┤╨╗╤Å ╤ü╨╕╨╜╤à╤Ç╨╛╨╜╨╕╨╖╨░╤å╨╕╨╕ ╤ü ╤ü╨╡╤Ç╨▓╨╡╤Ç╨╛╨╝

**╨Æ╨░╨╢╨╜╨╛:** ╨▓╤ü╨╡╨│╨┤╨░ ╤ü╨╛╤à╤Ç╨░╨╜╤Å╨╣╤é╨╡ ╨┐╤Ç╨╡╨┤╤ï╨┤╤â╤ë╨╡╨╡ ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╨╡ ╨┤╨╗╤Å ╨╛╤é╨║╨░╤é╨░! ╨æ╨╡╨╖ ╤ì╤é╨╛╨│╨╛ ╨┐╤Ç╨╕ ╨╛╤ê╨╕╨▒╨║╨╡ ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤î ╤â╨▓╨╕╨┤╨╕╤é ╨╜╨╡╨▓╨░╨╗╨╕╨┤╨╜╤ï╨╡ ╨┤╨░╨╜╨╜╤ï╨╡.

**╨ú╨┐╤Ç╨╛╤ë╤æ╨╜╨╜╤ï╨╣ ╤ü╨┐╨╛╤ü╨╛╨▒ ╨▓ v5:** ╨╝╨╛╨╢╨╜╨╛ ╨╕╤ü╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╤î `variables` ╨╕╨╖ ╤à╤â╨║╨░ ╨╝╤â╤é╨░╤å╨╕╨╕ ╨┤╨╗╤Å ╨┤╨╛╤ü╤é╤â╨┐╨░ ╨║ ╨┤╨░╨╜╨╜╤ï╨╝ ╨╝╤â╤é╨░╤å╨╕╨╕ ╨▓ `onMutate`:

```typescript
const updateUser = useMutation({
  mutationFn: updateUserApi,
  onMutate: async (newUser) => {
    // newUser ╨┤╨╛╤ü╤é╤â╨┐╨╡╨╜ ╨╜╨░╨┐╤Ç╤Å╨╝╤â╤Ä
    await queryClient.cancelQueries({ queryKey: ['users', newUser.id] })
    const previousUser = queryClient.getQueryData(['users', newUser.id])
    queryClient.setQueryData(['users', newUser.id], newUser)
    return { previousUser }
  },
  onError: (err, newUser, context) => {
    // ╨₧╤é╨║╨░╤é ╨║ ╨┐╤Ç╨╡╨┤╤ï╨┤╤â╤ë╨╡╨╝╤â ╤ü╨╛╤ü╤é╨╛╤Å╨╜╨╕╤Ä
    queryClient.setQueryData(['users', newUser.id], context?.previousUser)
  },
})
```

---

## 54.4. Prefetch (╨┐╤Ç╨╡╨┤╨╖╨░╨│╤Ç╤â╨╖╨║╨░)

╨ƒ╤Ç╨╡╨┤╨╖╨░╨│╤Ç╤â╨╖╨║╨░ ╨┐╨╛╨╖╨▓╨╛╨╗╤Å╨╡╤é ╨╖╨░╨│╤Ç╤â╨╖╨╕╤é╤î ╨┤╨░╨╜╨╜╤ï╨╡ **╨┤╨╛** ╤é╨╛╨│╨╛, ╨║╨░╨║ ╨╛╨╜╨╕ ╨┐╨╛╨╜╨░╨┤╨╛╨▒╤Å╤é╤ü╤Å. ╨Ü╨╛╨│╨┤╨░ ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤î ╨┐╨╡╤Ç╨╡╨╣╨┤╤æ╤é ╨╜╨░ ╤ü╤é╤Ç╨░╨╜╨╕╤å╤â ΓÇö ╨┤╨░╨╜╨╜╤ï╨╡ ╤â╨╢╨╡ ╨▓ ╨║╨╡╤ê╨╡.

**╨ö╨▓╨░ ╨┐╨╛╨┤╤à╨╛╨┤╨░:**

### prefetchQuery ΓÇö ╨╖╨░╨│╤Ç╤â╨╖╨║╨░ ╨┐╨╛ ╤ü╨╛╨▒╤ï╤é╨╕╤Ä

╨ù╨░╨│╤Ç╤â╨╢╨░╨╡╨╝ ╨┤╨░╨╜╨╜╤ï╨╡ ╨┐╤Ç╨╕ ╨╜╨░╨▓╨╡╨┤╨╡╨╜╨╕╨╕ ╨╜╨░ ╤ü╤ü╤ï╨╗╨║╤â. ╨Ü ╨╝╨╛╨╝╨╡╨╜╤é╤â ╨║╨╗╨╕╨║╨░ ╨┤╨░╨╜╨╜╤ï╨╡ ╤â╨╢╨╡ ╨▓ ╨║╨╡╤ê╨╡, ╤ü╤é╤Ç╨░╨╜╨╕╤å╨░ ╨╛╤é╨║╤Ç╤ï╨▓╨░╨╡╤é╤ü╤Å ╨╝╨│╨╜╨╛╨▓╨╡╨╜╨╜╨╛.

**╨ÿ╤ü╨┐╨╛╨╗╤î╨╖╤â╨╣╤é╨╡ ╨║╨╛╨│╨┤╨░:** ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤î ╤ü╨║╨╛╤Ç╨╡╨╡ ╨▓╤ü╨╡╨│╨╛ ╨┐╨╡╤Ç╨╡╨╣╨┤╤æ╤é ╨┐╨╛ ╤ü╤ü╤ï╨╗╨║╨╡ (hover ╨╜╨░ ╨║╨░╤Ç╤é╨╛╤ç╨║╨╡).

### initialData ΓÇö ╨╕╤ü╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╨╜╨╕╨╡ ╤ü╤â╤ë╨╡╤ü╤é╨▓╤â╤Ä╤ë╨╕╤à ╨┤╨░╨╜╨╜╤ï╤à

╨æ╨╡╤Ç╤æ╨╝ ╨┤╨░╨╜╨╜╤ï╨╡ ╨╕╨╖ ╤â╨╢╨╡ ╨╖╨░╨│╤Ç╤â╨╢╨╡╨╜╨╜╨╛╨│╨╛ ╤ü╨┐╨╕╤ü╨║╨░ ╨║╨░╨║ ╨╜╨░╤ç╨░╨╗╤î╨╜╤ï╨╡ ╨┤╨╗╤Å ╨┤╨╡╤é╨░╨╗╤î╨╜╨╛╨╣ ╤ü╤é╤Ç╨░╨╜╨╕╤å╤ï. UI ╤Ç╨╡╨╜╨┤╨╡╤Ç╨╕╤é╤ü╤Å ╨╝╨│╨╜╨╛╨▓╨╡╨╜╨╜╨╛ ╤ü ╨▒╨░╨╖╨╛╨▓╨╛╨╣ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╨╡╨╣, ╨┐╨╛╨║╨░ ╨╖╨░╨│╤Ç╤â╨╢╨░╤Ä╤é╤ü╤Å ╨┐╨╛╨╗╨╜╤ï╨╡ ╨┤╨░╨╜╨╜╤ï╨╡.

**╨ÿ╤ü╨┐╨╛╨╗╤î╨╖╤â╨╣╤é╨╡ ╨║╨╛╨│╨┤╨░:** ╤ü╨┐╨╕╤ü╨╛╨║ ╤â╨╢╨╡ ╤ü╨╛╨┤╨╡╤Ç╨╢╨╕╤é ╤ç╨░╤ü╤é╤î ╨┤╨░╨╜╨╜╤ï╤à ╨┤╨╗╤Å ╨┤╨╡╤é╨░╨╗╤î╨╜╨╛╨╣ ╤ü╤é╤Ç╨░╨╜╨╕╤å╤ï (╨╜╨░╨┐╤Ç╨╕╨╝╨╡╤Ç, ╨╕╨╝╤Å ╨╕ ╨░╨▓╨░╤é╨░╤Ç ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤Å).

---

## 54.5. Infinite Query (╨▒╨╡╤ü╨║╨╛╨╜╨╡╤ç╨╜╤ï╨╡ ╤ü╨┐╨╕╤ü╨║╨╕)

`useInfiniteQuery` ΓÇö ╤ü╨┐╨╡╤å╨╕╨░╨╗╤î╨╜╤ï╨╣ ╤à╤â╨║ ╨┤╨╗╤Å ╨┐╨░╨│╨╕╨╜╨░╤å╨╕╨╕ ╨╕ ╨▒╨╡╤ü╨║╨╛╨╜╨╡╤ç╨╜╨╛╨╣ ╨┐╤Ç╨╛╨║╤Ç╤â╤é╨║╨╕.

**╨₧╤é╨╗╨╕╤ç╨╕╤Å ╨╛╤é ╨╛╨▒╤ï╤ç╨╜╨╛╨│╨╛ useQuery:**

- ╨Ñ╤Ç╨░╨╜╨╕╤é ╨╝╨░╤ü╤ü╨╕╨▓ ╤ü╤é╤Ç╨░╨╜╨╕╤å `data.pages`, ╨░ ╨╜╨╡ ╨╛╨┤╨╕╨╜ ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é
- ╨ÿ╨╝╨╡╨╡╤é `fetchNextPage()` ╨╕ `fetchPreviousPage()` ╨┤╨╗╤Å ╨╜╨░╨▓╨╕╨│╨░╤å╨╕╨╕
- `getNextPageParam` ╨╛╨┐╤Ç╨╡╨┤╨╡╨╗╤Å╨╡╤é, ╨╡╤ü╤é╤î ╨╗╨╕ ╤ü╨╗╨╡╨┤╤â╤Ä╤ë╨░╤Å ╤ü╤é╤Ç╨░╨╜╨╕╤å╨░

**╨Ü╨╗╤Ä╤ç╨╡╨▓╤ï╨╡ ╤ü╨▓╨╛╨╣╤ü╤é╨▓╨░:**

- **data.pages** ΓÇö ╨╝╨░╤ü╤ü╨╕╨▓ ╨▓╤ü╨╡╤à ╨╖╨░╨│╤Ç╤â╨╢╨╡╨╜╨╜╤ï╤à ╤ü╤é╤Ç╨░╨╜╨╕╤å
- **hasNextPage** ΓÇö ╨╡╤ü╤é╤î ╨╗╨╕ ╨╡╤ë╤æ ╨┤╨░╨╜╨╜╤ï╨╡
- **fetchNextPage()** ΓÇö ╨╖╨░╨│╤Ç╤â╨╖╨╕╤é╤î ╤ü╨╗╨╡╨┤╤â╤Ä╤ë╤â╤Ä ╤ü╤é╤Ç╨░╨╜╨╕╤å╤â
- **isFetchingNextPage** ΓÇö ╨╖╨░╨│╤Ç╤â╨╢╨░╨╡╤é╤ü╤Å ╨╗╨╕ ╤ü╨╗╨╡╨┤╤â╤Ä╤ë╨░╤Å ╤ü╤é╤Ç╨░╨╜╨╕╤å╨░

**╨¥╨╛╨▓╨╛╨╡ ╨▓ v5: maxPages**

╨ö╨╗╤Å ╨┐╤Ç╨╡╨┤╨╛╤é╨▓╤Ç╨░╤ë╨╡╨╜╨╕╤Å ╤â╤é╨╡╤ç╨╡╨║ ╨┐╨░╨╝╤Å╤é╨╕ ╨▓ v5 ╨┤╨╛╨▒╨░╨▓╨╗╨╡╨╜ ╨┐╨░╤Ç╨░╨╝╨╡╤é╤Ç **`maxPages`**, ╨║╨╛╤é╨╛╤Ç╤ï╨╣ ╨╛╨│╤Ç╨░╨╜╨╕╤ç╨╕╨▓╨░╨╡╤é ╨║╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛ ╤ü╤é╤Ç╨░╨╜╨╕╤å ╨▓ ╨┐╨░╨╝╤Å╤é╨╕:

```typescript
useInfiniteQuery({
  queryKey: ['posts'],
  queryFn: ({ pageParam = 0 }) => fetchPosts(pageParam),
  getNextPageParam: (lastPage) => lastPage.nextCursor,
  maxPages: 10, // ╨£╨░╨║╤ü╨╕╨╝╤â╨╝ 10 ╤ü╤é╤Ç╨░╨╜╨╕╤å ╨▓ ╨┐╨░╨╝╤Å╤é╨╕
})
```

**╨ö╨▓╨░ ╨▓╨░╤Ç╨╕╨░╨╜╤é╨░ UX:**

1. **╨Ü╨╜╨╛╨┐╨║╨░ ┬½╨ù╨░╨│╤Ç╤â╨╖╨╕╤é╤î ╨╡╤ë╤æ┬╗** ΓÇö ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤î ╤ü╨░╨╝ ╤Ç╨╡╤ê╨░╨╡╤é, ╨║╨╛╨│╨┤╨░ ╨╖╨░╨│╤Ç╤â╨╢╨░╤é╤î
2. **Intersection Observer** ΓÇö ╨░╨▓╤é╨╛╨╝╨░╤é╨╕╤ç╨╡╤ü╨║╨░╤Å ╨╖╨░╨│╤Ç╤â╨╖╨║╨░ ╨┐╤Ç╨╕ ╤ü╨║╤Ç╨╛╨╗╨╗╨╡ ╨║ ╨║╨╛╨╜╤å╤â ╤ü╨┐╨╕╤ü╨║╨░

**╨á╨╡╨║╨╛╨╝╨╡╨╜╨┤╨░╤å╨╕╤Å:** ╨┤╨╗╤Å ╨▒╨╡╤ü╨║╨╛╨╜╨╡╤ç╨╜╨╛╨│╨╛ ╤ü╨║╤Ç╨╛╨╗╨╗╨░ ╨╕╤ü╨┐╨╛╨╗╤î╨╖╤â╨╣╤é╨╡ `react-intersection-observer` ╤ü `useInView()` ╤à╤â╨║╨╛╨╝.

---

## 54.6. Dependent Queries (╨╖╨░╨▓╨╕╤ü╨╕╨╝╤ï╨╡ ╨╖╨░╨┐╤Ç╨╛╤ü╤ï)

╨ÿ╨╜╨╛╨│╨┤╨░ ╨╖╨░╨┐╤Ç╨╛╤ü ╨╖╨░╨▓╨╕╤ü╨╕╤é ╨╛╤é ╤Ç╨╡╨╖╤â╨╗╤î╤é╨░╤é╨░ ╨┤╤Ç╤â╨│╨╛╨│╨╛ ╨╖╨░╨┐╤Ç╨╛╤ü╨░. ╨¥╨░╨┐╤Ç╨╕╨╝╨╡╤Ç: ╤ü╨╜╨░╤ç╨░╨╗╨░ ╨╖╨░╨│╤Ç╤â╨╖╨╕╤é╤î ╨┐╨╛╨╗╤î╨╖╨╛╨▓╨░╤é╨╡╨╗╤Å, ╨┐╨╛╤é╨╛╨╝ ╨╡╨│╨╛ ╨┐╨╛╤ü╤é╤ï.

**╨á╨╡╤ê╨╡╨╜╨╕╨╡:** ╨┐╨░╤Ç╨░╨╝╨╡╤é╤Ç `enabled`

╨ù╨░╨┐╤Ç╨╛╤ü ╨▓╤ï╨┐╨╛╨╗╨╜╤Å╨╡╤é╤ü╤Å ╤é╨╛╨╗╤î╨║╨╛ ╨║╨╛╨│╨┤╨░ `enabled: true`. ╨¡╤é╨╛ ╨┐╨╛╨╖╨▓╨╛╨╗╤Å╨╡╤é ╨▓╤ï╤ü╤é╤Ç╨░╨╕╨▓╨░╤é╤î ╤å╨╡╨┐╨╛╤ç╨║╨╕ ╨╖╨░╨▓╨╕╤ü╨╕╨╝╤ï╤à ╨╖╨░╨┐╤Ç╨╛╤ü╨╛╨▓.

**╨ó╨╕╨┐╨╕╤ç╨╜╤ï╨╡ ╤ü╨╗╤â╤ç╨░╨╕:**

- ╨ù╨░╨│╤Ç╤â╨╖╨║╨░ ╤ü╨▓╤Å╨╖╨░╨╜╨╜╤ï╤à ╨┤╨░╨╜╨╜╤ï╤à (user ΓåÆ posts)
- ╨ù╨░╨┐╤Ç╨╛╤ü ╨┐╨╛╤ü╨╗╨╡ ╨┐╨╛╨╗╤â╤ç╨╡╨╜╨╕╤Å ID ╨╕╨╖ ╨┤╤Ç╤â╨│╨╛╨│╨╛ ╨╖╨░╨┐╤Ç╨╛╤ü╨░
- ╨ú╤ü╨╗╨╛╨▓╨╜╨░╤Å ╨╖╨░╨│╤Ç╤â╨╖╨║╨░ (╤é╨╛╨╗╤î╨║╨╛ ╨┤╨╗╤Å ╨░╨▓╤é╨╛╤Ç╨╕╨╖╨╛╨▓╨░╨╜╨╜╤ï╤à)

**╨Æ╨░╨╢╨╜╨╛:** `enabled` ╨╝╨╛╨╢╨╡╤é ╨▒╤ï╤é╤î ╨╗╤Ä╨▒╤ï╨╝ boolean ╨▓╤ï╤Ç╨░╨╢╨╡╨╜╨╕╨╡╨╝: `enabled: !!user`, `enabled: isAuthenticated`, `enabled: id > 0`.

---

## 54.7. ╨ô╨╗╨╛╨▒╨░╨╗╤î╨╜╨░╤Å ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨░ ╨╛╤ê╨╕╨▒╨╛╨║

╨¥╨░╤ü╤é╤Ç╨╛╨╣╤é╨╡ retry-╨╗╨╛╨│╨╕╨║╤â ╨╜╨░ ╤â╤Ç╨╛╨▓╨╜╨╡ `QueryClient`, ╤ç╤é╨╛╨▒╤ï ╨╜╨╡ ╨┤╤â╨▒╨╗╨╕╤Ç╨╛╨▓╨░╤é╤î ╨║╨╛╨┤ ╨▓ ╨║╨░╨╢╨┤╨╛╨╝ ╨╖╨░╨┐╤Ç╨╛╤ü╨╡.

**╨á╨╡╨║╨╛╨╝╨╡╨╜╨┤╨░╤å╨╕╨╕ ╨┐╨╛ retry:**

- **404** ΓÇö ╨╜╨╡ ╨┐╨╛╨▓╤é╨╛╤Ç╤Å╤é╤î (╤Ç╨╡╤ü╤â╤Ç╤ü ╨╜╨╡ ╤ü╤â╤ë╨╡╤ü╤é╨▓╤â╨╡╤é)
- **401/403** ΓÇö ╨╜╨╡ ╨┐╨╛╨▓╤é╨╛╤Ç╤Å╤é╤î, ╤Ç╨╡╨┤╨╕╤Ç╨╡╨║╤é ╨╜╨░ ╨╗╨╛╨│╨╕╨╜
- **5xx ╨╕ ╤ü╨╡╤é╨╡╨▓╤ï╨╡ ╨╛╤ê╨╕╨▒╨║╨╕** ΓÇö ╨┐╨╛╨▓╤é╨╛╤Ç╨╕╤é╤î 2-3 ╤Ç╨░╨╖╨░ ╤ü exponential backoff

**Exponential backoff** ΓÇö ╤â╨▓╨╡╨╗╨╕╤ç╨╡╨╜╨╕╨╡ ╨╖╨░╨┤╨╡╤Ç╨╢╨║╨╕ ╨╝╨╡╨╢╨┤╤â ╨┐╨╛╨┐╤ï╤é╨║╨░╨╝╨╕: 1╤ü ΓåÆ 2╤ü ΓåÆ 4╤ü. ╨¡╤é╨╛ ╤ü╨╜╨╕╨╢╨░╨╡╤é ╨╜╨░╨│╤Ç╤â╨╖╨║╤â ╨╜╨░ ╤ü╨╡╤Ç╨▓╨╡╤Ç ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝╨░╤à.

**╨ô╨╗╨╛╨▒╨░╨╗╤î╨╜╤ï╨╣ onError ╨┤╨╗╤Å ╨╝╤â╤é╨░╤å╨╕╨╣:**

- ╨ƒ╨╛╨║╨░╨╖ toast ╤ü ╤ü╨╛╨╛╨▒╤ë╨╡╨╜╨╕╨╡╨╝ ╨╛╨▒ ╨╛╤ê╨╕╨▒╨║╨╡
- ╨¢╨╛╨│╨╕╤Ç╨╛╨▓╨░╨╜╨╕╨╡ ╨▓ ╤ü╨╕╤ü╤é╨╡╨╝╤â ╨░╨╜╨░╨╗╨╕╤é╨╕╨║╨╕
- ╨á╨╡╨┤╨╕╤Ç╨╡╨║╤é ╨┐╤Ç╨╕ 401

**╨ƒ╤Ç╨╡╨╕╨╝╤â╤ë╨╡╤ü╤é╨▓╨╛:** ╨▓╤ü╤Å ╨╗╨╛╨│╨╕╨║╨░ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨╕ ╨╛╤ê╨╕╨▒╨╛╨║ ╨▓ ╨╛╨┤╨╜╨╛╨╝ ╨╝╨╡╤ü╤é╨╡, ╨╗╨╡╨│╨║╨╛ ╨┐╨╛╨┤╨┤╨╡╤Ç╨╢╨╕╨▓╨░╤é╤î ╨╕ ╨╝╨╡╨╜╤Å╤é╤î.

---

## ╨Æ╨╛╨┐╤Ç╨╛╤ü╤ï ╨╜╨░ ╤ü╨╛╨▒╨╡╤ü╨╡╨┤╨╛╨▓╨░╨╜╨╕╨╕

### 1. ╨º╤é╨╛ ╤é╨░╨║╨╛╨╡ optimistic update?

╨₧╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡ UI ╨┤╨╛ ╨┐╨╛╨╗╤â╤ç╨╡╨╜╨╕╤Å ╨╛╤é╨▓╨╡╤é╨░ ╨╛╤é ╤ü╨╡╤Ç╨▓╨╡╤Ç╨░ ╨┤╨╗╤Å ╨╝╨│╨╜╨╛╨▓╨╡╨╜╨╜╨╛╨│╨╛ UX. ╨ƒ╤Ç╨╕ ╨╛╤ê╨╕╨▒╨║╨╡ ╨▓╤ï╨┐╨╛╨╗╨╜╤Å╨╡╤é╤ü╤Å ╨╛╤é╨║╨░╤é.

### 2. ╨Ü╨░╨║ ╤Ç╨░╨▒╨╛╤é╨░╨╡╤é invalidation?

╨ƒ╨╛╨╝╨╡╤ç╨░╨╡╤é ╨┤╨░╨╜╨╜╤ï╨╡ ╨║╨░╨║ ╤â╤ü╤é╨░╤Ç╨╡╨▓╤ê╨╕╨╡ ╨╕ ╨▓╤ï╨╖╤ï╨▓╨░╨╡╤é ╨╕╤à ╨╛╨▒╨╜╨╛╨▓╨╗╨╡╨╜╨╕╨╡. ╨£╨╛╨╢╨╜╨╛ ╤é╨╛╤ç╨╡╤ç╨╜╨╛ ╨╕╨╜╨▓╨░╨╗╨╕╨┤╨╕╤Ç╨╛╨▓╨░╤é╤î ╤ç╨╡╤Ç╨╡╨╖ query keys.

### 3. ╨ù╨░╤ç╨╡╨╝ ╨╜╤â╨╢╨╡╨╜ prefetch?

╨ƒ╤Ç╨╡╨┤╨╖╨░╨│╤Ç╤â╨╖╨║╨░ ╨┤╨░╨╜╨╜╤ï╤à ╨┐╨╡╤Ç╨╡╨┤ ╨╜╨░╨▓╨╕╨│╨░╤å╨╕╨╡╨╣ ╨┤╨╗╤Å ╨╝╨│╨╜╨╛╨▓╨╡╨╜╨╜╨╛╨╣ ╨╛╤é╤Ç╨╕╤ü╨╛╨▓╨║╨╕ ╤ü╤é╤Ç╨░╨╜╨╕╤å╤ï.

### 4. ╨º╤é╨╛ ╤é╨░╨║╨╛╨╡ infinite query?

╨ö╨╗╤Å ╨┐╨░╨│╨╕╨╜╨░╤å╨╕╨╕ ╨╕ ╨▒╨╡╤ü╨║╨╛╨╜╨╡╤ç╨╜╨╛╨╣ ╨┐╤Ç╨╛╨║╤Ç╤â╤é╨║╨╕. ╨₧╨▒╤è╨╡╨┤╨╕╨╜╤Å╨╡╤é ╤ü╤é╤Ç╨░╨╜╨╕╤å╤ï ╨▓ ╨╛╨┤╨╕╨╜ ╨╝╨░╤ü╤ü╨╕╨▓.

### 5. ╨Ü╨░╨║ ╨╛╨▒╤Ç╨░╨▒╨░╤é╤ï╨▓╨░╤é╤î ╨╛╤ê╨╕╨▒╨║╨╕ ╨▓ ╨╝╤â╤é╨░╤å╨╕╤Å╤à?

╨º╨╡╤Ç╨╡╨╖ `onError` ╨▓ ╨╝╤â╤é╨░╤å╨╕╨╕ ╨╕╨╗╨╕ ╨│╨╗╨╛╨▒╨░╨╗╤î╨╜╨╛ ╨▓ `defaultOptions.mutations.onError`.
