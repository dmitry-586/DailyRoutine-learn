# Глава 20. SSR и современный React-стек

Современный фронтенд — это уже не просто SPA, загружаемая одним JS-файлом. Сегодня важно понимать где выполняется код, когда происходит рендер и какой код доезжает до браузера.

На собеседованиях SSR — частый фильтр на уровень Middle+.

---

## 20.1. Проблемы классического SPA

Классическое SPA имеет ряд ограничений:

- долгий Time To First Contentful Paint (TTFB)
- пустой HTML при первой загрузке
- проблемы SEO (поисковики видят пустую страницу)
- плохой UX на медленных сетях
- долгая интерактивность (TTI)

---

## 20.2. SSR (Server-Side Rendering)

SSR — рендеринг React-приложения на сервере.

### Как это работает

1. Клиент запрашивает страницу
2. Сервер рендерит React в HTML
3. Клиент получает готовую разметку
4. JS «гидратирует» приложение (hydration)

### Hydration

Hydration — процесс, при котором React:

- привязывает обработчики событий
- делает HTML интерактивным
- восстанавливает состояние

⚠️ HTML должен совпадать с клиентским рендером. Несоответствие → hydration errors.

### Преимущества SSR

- быстрый First Contentful Paint
- лучше SEO
- работает без JavaScript
- лучший UX на медленных сетях

### Недостатки

- нагрузка на сервер
- сложнее архитектура
- проблемы с гидратацией

---

## 20.3. Next.js

Next.js — стандарт де-факто для SSR/SSG в React.

### Версии и эволюция

- Next.js 9-12: Pages Router с getServerSideProps/getStaticProps
- Next.js 13+: App Router с Server Components (по умолчанию)
- Next.js 15+: Улучшенная производительность, новые оптимизации
- Next.js 16: Стабильные Server Components, улучшенный кэшинг, новые API

### Next.js 16 — ключевые улучшения

- Стабильные React Server Components (RSC)
- Улучшенная система кэширования
- Оптимизированная работа с изображениями
- Улучшенная поддержка TypeScript
- Новые API для работы с данными
- Улучшенная производительность сборки

### Типы рендеринга

**SSR:**

- Когда: на каждый запрос
- Особенности: динамический контент

**SSG:**

- Когда: на этапе билда
- Особенности: статический контент, быстрее

**ISR:**

- Когда: SSG + обновление
- Особенности: гибридный подход — страница статическая, но может «переиздаваться» по расписанию или по запросу

**CSR:**

- Когда: на клиенте
- Особенности: классическое SPA

### Примеры SSR / SSG / ISR на уровне понимания

**SSR (на уровне Next.js App Router):**

- страница `/products/[id]` рендерится на сервере на каждый запрос;
- компонент в `app/products/[id]/page.tsx` — **Server Component**;
- данные получаются прямо в компоненте через `await fetch(...)`;
- пользователю сразу приходит HTML с контентом товара.

Фронтендеру важно понимать: при SSR ты **платишь временем сервера** за то, чтобы пользователь быстрее увидел готовый экран.

**SSG:**

- документация, блог, лендинг, список статей;
- страницы генерируются во время билда (или при первом заходе, если используется on‑demand SSG);
- при запросе отдаются как обычные статические HTML‑страницы с минимальной нагрузкой на сервер.

**ISR (Incremental Static Regeneration):**

- SSG + периодическое обновление;
- пример: `/blog/[slug]` пересобирается раз в N секунд (revalidate) или по webhook;
- пользователь **всегда получает статическую страницу**, но где‑то в фоне Next.js время от времени делает «свежий снимок» контента.

Такой подход часто объясняют через аналогию с газетой: она **статична для читателя**, но выпускается регулярно с новыми данными.

---

## 20.4. Server Components

React Server Components — новый этап эволюции React.

React Server Components доступны в Next.js 13+ (App Router). В App Router компоненты по умолчанию являются Server Components. Client Components помечаются директивой 'use client'.

### Идея

- код выполняется на сервере
- не попадает в JS-бандл
- уменьшает размер клиента
- прямой доступ к БД и файловой системе

### Отличия от SSR

**SSR:**

- HTML + JS
- гидратация
- большой бандл
- полный JS на клиенте

**Server Components:**

- только HTML
- нет гидратации
- меньший бандл
- только клиентские компоненты

### Server Components

- не могут использовать хуки
- не могут использовать браузерные API
- выполняются только на сервере

### Client Components (помечаются "use client")

- могут использовать хуки
- интерактивность
- браузерные API

---

## 20.5. Код-сплиттинг и оптимизация

### Dynamic import

```javascript
const Heavy = lazy(() => import('./Heavy'))
```

### Suspense

```jsx
<Suspense fallback={<Loader />}>
  <Heavy />
</Suspense>
```

### Route-based splitting

Каждый роут — отдельный чанк. Автоматически в Next.js, вручную в React Router.

### Почему это важно

- меньше начальный JS-бандл
- быстрее загрузка
- лучший Core Web Vitals
- пользователь загружает только нужный код

---

## 20.6. Concurrent Features

React 18+ concurrent features:

### Automatic batching

Группирует обновления состояния для оптимизации.

### startTransition

Помечает обновления как не срочные.

```javascript
startTransition(() => {
  setValue(v)
})
```

### useTransition

```javascript
const [isPending, startTransition] = useTransition()
```

Позволяет React отдавать приоритет более важным обновлениям.

### Suspense для данных

Асинхронная загрузка данных с fallback UI.

---

## Вопросы на собеседовании

### 1. Проблемы классического SPA?

Долгий TTFB, пустой HTML, проблемы SEO, плохой UX на медленных сетях.

### 2. Что такое SSR?

Рендеринг React на сервере, отправка готового HTML клиенту, затем гидратация.

### 3. Что такое hydration?

Процесс привязки обработчиков событий к серверному HTML, делающий его интерактивным.

### 4. SSR vs SSG?

SSR — на каждый запрос (динамический). SSG — на этапе билда (статический, быстрее).

### 5. Когда использовать Next.js?

Когда нужен SSR/SSG, SEO, быстрая загрузка, современный React-стек.

### 6. Что такое Server Components?

Компоненты, выполняющиеся только на сервере, не попадающие в JS-бандл.

### 7. Что даёт код-сплиттинг?

Меньший начальный бандл, загрузка кода по требованию, лучшая производительность.

### 8. Что такое Concurrent Mode?

Механизм React для приоритизации обновлений, прерывания рендеринга, улучшения отзывчивости.

### 9. Что нового в Next.js 16?

- Стабильные React Server Components (RSC)
- Улучшенная система кэширования
- Оптимизированная работа с изображениями
- Улучшенная поддержка TypeScript
- Новые API для работы с данными
- Улучшенная производительность сборки

### 10. Pages Router vs App Router в Next.js?

- Pages Router (Next.js 9-12): getServerSideProps, getStaticProps, файловая маршрутизация
- App Router (Next.js 13+): Server Components по умолчанию, async компоненты, улучшенная производительность
- Next.js 16: дальнейшие оптимизации App Router, стабильные RSC

---

## Key Takeaways

- SSR решает проблемы SEO и производительности SPA
- Next.js — стандарт для SSR/SSG в React
- Next.js 16 улучшает производительность и стабильность Server Components
- App Router (Next.js 13+) — современный подход с Server Components по умолчанию
- Server Components уменьшают размер клиентского бандла
- Код-сплиттинг критичен для производительности
- Concurrent Features улучшают отзывчивость интерфейса
- Hydration требует совпадения серверного и клиентского HTML
- ISR — гибридный подход между SSG и SSR

---

В следующей части мы сделаем шаг назад от конкретных технологий и посмотрим на архитектуру целиком: как структурировать проект, разделять ответственность, выбирать подходящий уровень сложности и не превращать кодовую базу в «большой шар грязи».
