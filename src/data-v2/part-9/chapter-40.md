# Глава 40. Зависимости: package.json, semver, lockfiles и выбор менеджера

Эта глава про практику: как фиксировать зависимости и какой менеджер выбрать, чтобы проект был воспроизводимым и предсказуемым.

---

## 40.1. package.json: сердце проекта

package.json — это контракт проекта.

### Основные поля

```json
{
  "name": "my-app",
  "version": "1.0.0",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "lint": "next lint"
  },
  "dependencies": {
    "react": "^18.3.0",
    "next": "^15.0.0"
  },
  "devDependencies": {
    "typescript": "^5.7.0",
    "eslint": "^9.0.0"
  },
  "engines": {
    "node": ">=20.0.0"
  }
}
```

- `dependencies` — всё, что нужно в runtime.
- `devDependencies` — только разработка, сборка, тесты.
- `peerDependencies` нужны библиотекам, чтобы не тащить дубликаты (например React).
- `optionalDependencies` — необязательные вещи, установка может пропасть без ошибки.

---

## 40.2. SemVer (Semantic Versioning)

- **MAJOR** — несовместимые изменения.
- **MINOR** — новые функции без ломания.
- **PATCH** — багфиксы.

Диапазоны:

- `^1.2.3` → разрешает minor + patch.
- `~1.2.3` → разрешает только patch.
- `1.2.3` → фикс.

---

## 40.3. Lock-файлы

Lock-файл фиксирует точные версии всех зависимостей и делает сборки одинаковыми у всех.

- npm → `package-lock.json`
- pnpm → `pnpm-lock.yaml`
- yarn → `yarn.lock`
- bun → `bun.lockb`

Правило простое: **lock-файл всегда коммитим** и **не смешиваем менеджеры**.

---

## 40.4. Сравнение менеджеров

### npm
- Встроен в Node.js, максимум совместимости.
- Нормальная скорость, большой рынок пакетов.
- Хорош для стандартных проектов и команд без особых требований.

### pnpm
- Быстрее и экономит диск за счёт общего store.
- Жёстче к зависимостям (нет скрытых импортов).
- Лучший выбор для монорепо.

### Yarn Classic (v1)
- Стабильный, но архитектурно старый.
- Подходит для legacy-проектов.

### Yarn Berry (v3+)
- По умолчанию **PnP** (без `node_modules`).
- Очень быстрый, но требует привыкания и правильной настройки IDE.
- Хорош в крупных репозиториях, но может ломать экосистему.

### Bun
- Самый быстрый, но менее зрелый.
- Хорош для экспериментов и pet-проектов, осторожно в проде.

---

## 40.5. Что реально нужно на проекте

- Выберите **один** менеджер на команду и закрепите это в README.
- Коммитьте lock-файл и не меняйте его вручную.
- Для CI используйте «чистую» установку (`npm ci`, `pnpm install --frozen-lockfile`).
- Обновляйте зависимости регулярно, но **мажоры** — только вручную.
- Не тяните тяжёлые пакеты «на всякий случай».