# Глава 42. Оптимизация бандла: логика и последовательность

Цель — быстрее первый экран и меньше JS. Делай оптимизацию по шагам, чтобы понимать, зачем именно ты что-то меняешь.

---

## 42.1. Шаг 1 — понять, что тормозит

Сначала измерь: какой у тебя размер бандла и какие чанки самые тяжёлые. Без этого легко «оптимизировать» не то.

---

## 42.2. Шаг 2 — убрать неиспользуемое (tree-shaking)

Tree-shaking удаляет неиспользуемые экспорты, если:

- используются ES Modules,
- импорты статические,
- модуль без side-effects.

Минимальный пример:

```ts
// Хорошо: ESM + именованные экспорты
import { sum } from './math'
```

Если модуль делает побочные эффекты (например импортирует CSS), он не будет «выкинут».

---

## 42.3. Шаг 3 — разделить загрузку (code splitting)

Смысл: не грузить всё сразу. Пользователю нужен только текущий экран.

### Динамический импорт

```tsx
const HeavyChart = lazy(() => import('./HeavyChart'))
```

### Когда это нужно

- редкие экраны (админка, отчёты),
- тяжёлые библиотеки (графики, редакторы),
- большие модальные окна.

---

## 42.4. Шаг 4 — контролировать импорты

- Импортируй только то, что используешь.
- Для тяжёлых библиотек ищи «лёгкие» альтернативы.
- Не тащи весь пакет «на всякий случай».

---

## 42.5. Минимальный чек-лист

- Бандл измерен.
- Динамические импорты стоят там, где это реально помогает.
- Большие библиотеки загружаются лениво.
- Лишние импорты удалены.

Этого достаточно, чтобы получить реальный выигрыш без лишней сложности.

---

## 42.6. Как измерять правильно

- Замеряй **общий размер JS** и **размер первого экрана**.
- Сравнивай до/после одной конкретной правки.
- Смотри, какие чанки грузятся на первом экране.
- Учитывай кеш: повторный заход может быть быстрым, но первый — нет.

---

## 42.7. Типичные источники «жирного» бандла

- Библиотеки графиков, редакторов и PDF.
- UI-комплекты с монолитными импортами.
- Большие утилиты, которые можно заменить локальной функцией.
- Дублирование библиотек из-за разных версий.

---

## 42.8. Что важно для UX

- Пользователь ждёт **первый экран**, а не весь сайт.
- Слишком много «ленивых» чанков даёт эффект «постоянной подгрузки».
- Баланс важнее максимального дробления.

---

## 42.9. Практические правила

- Ленивая загрузка — только для реально редких экранов.
- Общие библиотеки лучше держать в одном стабильном чанке.
- Для модалок и редких функций — динамический импорт.
- Для общих компонентов — статический импорт.

---

## 42.10. Ошибки, которые часто делают

- Включают динамический импорт «везде», и UX становится хуже.
- Удаляют полифиллы, ломая старые браузеры, если они нужны.
- Заменяют библиотеку ради размера, теряя функциональность.

---

## 42.11. Мини-бюджет производительности

Определи лимиты для команды:

- Размер JS первого экрана.
- Максимальный размер одного чанка.
- Время загрузки на медленной сети.

Это дисциплинирует и даёт понятные цели.
