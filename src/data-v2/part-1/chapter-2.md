# Глава 2. Транспортный уровень: TCP, UDP, QUIC, RTT и задержки

Транспортный уровень — это фундамент, на котором строится весь веб. Понимание TCP, UDP и QUIC критично для понимания производительности сетевых запросов и оптимизации загрузки.

---

## 2.1. TCP — надёжный транспорт

TCP обеспечивает:

- гарантированную доставку
- контроль последовательности
- контроль потерь
- повторную отправку пакетов

Это похоже на отправку посылки с квитанцией о получении: пока получатель не подтвердит, что всё дошло, отправитель считает передачу незавершённой и при необходимости шлёт повторно. Для приложений, где важна целостность данных (интернет‑банк, оформление заказа, API), это критично.

### Трёхстороннее рукопожатие (3‑way handshake)

До того как первый байт вашего HTTP‑запроса отправится на сервер, участники должны «поздороваться» и согласовать начальные номера последовательности (sequence numbers).

Упрощённо это выглядит так:

1. **Клиент → Сервер: SYN**  
   Клиент говорит: «Хочу открыть соединение, мой стартовый номер X».
2. **Сервер → Клиент: SYN‑ACK**  
   Сервер отвечает: «Ок, принимаю твой X, мой стартовый номер Y».
3. **Клиент → Сервер: ACK**  
   Клиент подтверждает: «Принял твой Y, поехали передавать данные».

Только **после** третьего шага в канал пойдут полезные данные (HTTP‑запрос). Каждый сегмент получает номер, и получатель подтверждает успешное получение **ACK‑пакетами**. Если подтверждение не пришло — пакет будет отправлен заново.

**Последствия для фронтенда:**

- первое соединение к домену всегда дороже (DNS + TCP + часто ещё TLS);
- на мобильных или высоколатентных сетях один 3‑way handshake легко стоит 100–200 мс;
- поэтому так важны **keep‑alive** и протоколы, уменьшающие количество handshake (HTTP/2, HTTP/3, TLS 1.3).

---

## 2.2. UDP — быстрый, но безгарантийный транспорт

UDP — простой и быстрый протокол **без установления соединения и без гарантий доставки**.

Характеристики:

- нет рукопожатия: пакет можно отправить сразу;
- нет гарантии, что пакет дойдёт;
- нет гарантии порядка (пакеты могут прийти вперемешку);
- нет автоматической повторной отправки.

Можно думать о UDP как о «почтовых открытках без уведомления о вручении»: быстро и дёшево, но часть из них может потеряться по дороге, а некоторые придут не в том порядке, в котором вы их отправляли.

**Где это полезно:**

- стриминг видео и аудио (важнее текущий кадр, чем идеальная доставка всех предыдущих);
- WebRTC (видеозвонки, созвоны в браузере);
- онлайн‑игры (важнее актуальное положение игрока, чем точная доставка всех старых позиций);
- DNS (маленькие независимые запросы/ответы).

---

## 2.3. QUIC и HTTP/3

Многие современные протоколы, в том числе **QUIC (HTTP/3)**, строят **свою надёжность поверх UDP**: они реализуют повторную отправку, контроль порядка и шифрование на уровне протокола, но избегают классического TCP‑рукопожатия и его задержек.

**HTTP/3 (QUIC):**

- работает поверх UDP
- каждый HTTP-поток — независимый
- потери не блокируют остальные запросы
- 0-RTT для повторных подключений (после первого handshake)
- меньше задержек в мобильных сетях

Сегодня HTTP/3 даёт лучшую стабильность и скорость, особенно на мобильных.

---

## 2.4. RTT (Round-Trip Time) и задержки

**RTT** — это время, которое требуется пакету данных, чтобы дойти от клиента до сервера и вернуться обратно. Это фундаментальная метрика производительности сети.

**Как это работает:**

1. Клиент отправляет пакет → сервер (время: T1)
2. Сервер обрабатывает и отправляет ответ → клиент (время: T2)
3. **RTT = T1 + T2** (общее время туда-обратно)

**Почему это важно:**

- На локальной сети: RTT ≈ 1–5 мс
- В пределах одной страны: RTT ≈ 20–50 мс
- Между континентами: RTT ≈ 100–300 мс
- На мобильных сетях: RTT может быть 200–500 мс

**Влияние на производительность:**

Каждый RTT добавляет задержку. Например, классический TLS handshake требует:

- 1 RTT для TCP handshake
- 1 RTT для TLS handshake
- Итого: минимум 2 RTT до первого байта данных

На высоколатентных сетях (200 мс RTT) это уже 400 мс задержки только на установку соединения, что критично для пользовательского опыта.

**Оптимизации:**

- **TLS 1.3** и **HTTP/3 (QUIC)** поддерживают **0-RTT** для повторных подключений: если клиент уже подключался к серверу, он может сразу отправить данные вместе с первым пакетом, экономя один RTT.
- **HTTP/2** и **HTTP/3** позволяют отправлять несколько запросов параллельно в одном соединении, уменьшая количество RTT для множественных ресурсов.

---

## Вопросы на собеседовании

### 1. Чем TCP отличается от UDP?

TCP — надёжный протокол с гарантией доставки, но с задержками из-за handshake. UDP — быстрый, без гарантий, используется для стриминга и игр.

### 2. Что такое 3-way handshake?

Процесс установки TCP-соединения: SYN → SYN-ACK → ACK. Требует минимум 1 RTT.

### 3. Что такое RTT?

Round-Trip Time — время прохождения пакета от клиента до сервера и обратно.

### 4. Как QUIC решает проблемы TCP?

QUIC работает поверх UDP, избегая TCP handshake, и реализует надёжность на уровне протокола. Поддерживает 0-RTT для повторных подключений.
