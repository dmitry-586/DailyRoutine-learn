# Глава 3. HTTP: протокол, методы, коды, редиректы, request/response, headers/body

HTTP (HyperText Transfer Protocol) — это протокол прикладного уровня, который лежит в основе всего веба. Понимание HTTP критично для фронтенд-разработчика: от правильного использования методов до понимания заголовков и кодов состояния.

---

## 3.1. HTTP/1.1 vs HTTP/2 vs HTTP/3

### HTTP/1.1

- последовательные запросы
- head-of-line blocking
- нужно много TCP-соединений
- нагрузки на сервер больше

Браузер открывает до 6 соединений на домен. Каждое соединение может обрабатывать только один запрос за раз. На медленных сетях это катастрофа.

### HTTP/2

Решает ключевые проблемы:

- мультиплексирование (несколько запросов в одном TCP)
- сервер пушит данные (Server Push)
- бинарный протокол
- сжатие заголовков (HPACK)

**Проблема:** TCP всё ещё медленный при потерях.

### HTTP/3 (QUIC)

- работает поверх UDP
- каждый HTTP-поток — независимый
- потери не блокируют остальные запросы
- 0-RTT для повторных подключений (после первого handshake)
- меньше задержек в мобильных сетях

Сегодня HTTP/3 даёт лучшую стабильность и скорость, особенно на мобильных.

---

## 3.2. HTTPS и TLS Handshake

`HTTPS = HTTP + TLS (шифрование)`

**Процесс установки защищённого соединения:**

1. Клиент отправляет список поддерживаемых алгоритмов
2. Сервер выбирает алгоритм и отправляет сертификат
3. Клиент проверяет сертификат (trusted CA)
4. Обмениваются ключами
5. Устанавливается шифрованный канал

**Проблема:** это обычно добавляет 1 RTT (round-trip time)

В HTTP/3 это оптимизировано через QUIC и 0-RTT handshake.

---

## 3.3. Структура HTTP-запроса и ответа

### HTTP Request

```
GET /api/users HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0
Accept: application/json
Authorization: Bearer token123

[тело запроса, если есть]
```

**Компоненты:**

- **Request Line**: метод, путь, версия протокола
- **Headers**: метаданные запроса
- **Body**: данные (для POST, PUT, PATCH)

### HTTP Response

```
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 1234
Cache-Control: max-age=3600

{"data": "..."}
```

**Компоненты:**

- **Status Line**: версия протокола, код состояния, текст статуса
- **Headers**: метаданные ответа
- **Body**: данные ответа

### Content-Type

Важный заголовок, который указывает тип данных:

- `application/json` — JSON данные
- `application/xml` — XML данные
- `text/html` — HTML
- `text/css` — CSS
- `application/javascript` — JavaScript
- `multipart/form-data` — формы с файлами

---

## 3.4. Методы HTTP и идемпотентность

### Методы

- **GET** — без побочных эффектов, получение данных
- **POST** — создаёт данные, неидемпотентный
- **PUT** — заменяет ресурс целиком (идемпотентный)
- **PATCH** — частично обновляет ресурс
- **DELETE** — удаляет ресурс (идемпотентный)
- **HEAD** — как GET, но без тела ответа (только заголовки)
- **OPTIONS** — запрос информации о поддерживаемых методах и CORS

### HEAD и OPTIONS

**HEAD** — идентичен GET, но сервер возвращает только заголовки без тела ответа. Используется для:

- проверки существования ресурса без загрузки данных
- проверки размера файла (заголовок `Content-Length`)
- проверки актуальности кэша (заголовки `ETag`, `Last-Modified`)
- экономии трафика при проверке статуса

**OPTIONS** — запрос информации о возможностях сервера для указанного ресурса. Используется для:

- **CORS preflight** запросов: браузер автоматически отправляет OPTIONS перед «сложными» запросами (POST с кастомными заголовками, PUT, DELETE и т.д.)
- проверки поддерживаемых методов (`Allow: GET, POST, PUT, DELETE`)
- проверки CORS политики (`Access-Control-Allow-*`)

### Идемпотентность

Идемпотентный запрос можно повторить без изменения результата.

- GET — да
- HEAD — да
- PUT — да (полная замена ресурса)
- DELETE — обычно да (повторное удаление не меняет состояние)
- PATCH — обычно нет (частичное обновление может быть неидемпотентным)
- POST — нет
- OPTIONS — да (информационный запрос)

**Важно:** Идемпотентность не означает, что ответ будет одинаковым (например, `DELETE` может вернуть `200 OK` при первом вызове и `404 Not Found` при повторном), но **состояние ресурса** не изменится после первого успешного выполнения.

На собеседованиях любят задавать вопрос про PUT vs PATCH и про идемпотентность методов.

---

## 3.5. Коды состояния HTTP

**Группы:**

- 1xx — информационные
- 2xx — успех
- 3xx — редиректы
- 4xx — ошибка клиента
- 5xx — ошибка сервера

**Важно знать:**

- `200 OK` — успешный запрос
- `201 Created` — ресурс создан
- `301/302 Redirect` — постоянный/временный редирект
- `304 Not Modified` — не скачивай, у тебя есть свежая копия (кэш)
- `400 Bad Request` — ошибка в запросе
- `401 Unauthorized` — требуется аутентификация
- `403 Forbidden` — доступ запрещён
- `404 Not Found` — ресурс не найден
- `429 Too Many Requests` — лимиты запросов
- `500 Internal Server Error` — ошибка сервера
- `503 Service Unavailable` — сервис недоступен

### Редиректы

**301 Moved Permanently** — постоянный редирект. Браузер кэширует новое местоположение.

**302 Found (Temporary Redirect)** — временный редирект. Браузер не кэширует.

**307 Temporary Redirect** — как 302, но сохраняет метод запроса.

**308 Permanent Redirect** — как 301, но сохраняет метод запроса.

---

## Вопросы на собеседовании

### 1. В чём отличие HTTP/1.1, HTTP/2 и HTTP/3?

- HTTP/1.1 — много соединений, блокировки
- HTTP/2 — одно соединение, мультиплексирование
- HTTP/3 — QUIC/UDP, меньше задержек, устойчивость при потере пакетов

### 2. Что такое идемпотентность?

Свойство запроса, позволяющее повторять его без изменения результата. GET, PUT, DELETE — идемпотентны, POST — нет.

### 3. Чем PUT отличается от PATCH?

PUT — полная замена ресурса (идемпотентный). PATCH — частичное обновление (может быть неидемпотентным).

### 4. Что такое TLS Handshake?

Процесс установки защищённого соединения, включающий обмен сертификатами и ключами. Обычно добавляет 1 RTT к первому запросу.

### 5. Какие коды состояния HTTP вы знаете?

200 OK, 201 Created, 301/302 Redirect, 304 Not Modified, 400 Bad Request, 401/403 Authorization, 404 Not Found, 429 Too Many Requests, 500 Internal Error, 503 Service Unavailable.
