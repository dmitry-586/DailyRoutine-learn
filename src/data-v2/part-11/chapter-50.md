# Глава 50. Тестирование: зачем, где помогает и где мешает

Про тесты часто говорят как про «обязательную галочку». На реальном проекте это обычно заканчивается двумя крайностями:

- «тестов нет», и каждый рефакторинг похож на прогулку по минному полю;
- «тестов слишком много», и команда начинает ненавидеть любые изменения.

Цель этой главы — не “воспитать правильного тестировщика”, а дать ощущение контроля: **что тестировать**, **почему это окупается**, и **как не превратить тестирование в бюрократию**.

---

## 50.1. Что такое тест (по-взрослому)

Тест — это договорённость: *«когда мы делаем X, система должна вести себя как Y»*.

Не «проверим строчку кода», не «померяем покрытие», а именно поведение. Код можно переписать десять раз, а поведение (если продукт жив) останется тем же.

Хороший тест отвечает на два вопроса:

- **какое поведение мы защищаем**;
- **почему это поведение важно** (чем больно, если сломается).

---

## 50.2. Зачем тесты реально нужны (и почему это не про “качество”)

Представь обычную неделю разработки.

Ты меняешь валидацию формы: «ничего серьёзного, просто поправить правило». PR зелёный, ревью пройдено, релиз — и через два дня прилетает баг: часть пользователей не может отправить форму, потому что один из крайних кейсов перестал работать.

Тесты в таких местах работают как **страховка от регресса**:

- они дают **ранний сигнал** (сломалось в PR, а не в проде);
- позволяют **рефакторить смелее**, потому что есть “охранные” проверки;
- сохраняют **знание о договорённостях**: какие кейсы считаются важными, какие ошибки должны показываться, что нельзя ломать.

Важно: тесты не делают код идеальным. Они делают изменения **менее страшными**.

---

## 50.3. Где тесты вредят (да, такое бывает)

Тесты начинают мешать, когда:

- тестируют **реализацию**, а не поведение (любой рефакторинг ломает тесты);
- пишут **E2E на всё**, и прогон занимает вечность;
- злоупотребляют **моками**, и тесты превращаются в «симуляцию симуляции»;
- копят **flaky-тесты**, и команда перестаёт доверять CI.

Простой критерий: если тесты чаще мешают, чем помогают — проблема не в тестировании как идее, а в выбранной стратегии.

---

## 50.4. Типы тестов и почему «пирамида» — это про экономику

На фронтенде чаще всего используют три уровня:

- **Unit** — маленькие куски логики (функции, форматирование, вычисления, редьюсеры).
- **Integration** — несколько частей вместе дают нужное поведение (компонент + хук + работа с данными).
- **E2E** — сценарий глазами пользователя (открыл страницу → сделал действие → получил результат).

Пирамида тестов — это не теория ради теории. Это про стоимость:

- Unit тесты дешёвые: быстрые и предсказуемые.
- Integration дороже: больше контекста, больше причин падения.
- E2E самые дорогие: медленные, хрупкие, зависят от окружения.

Поэтому нормальный баланс выглядит так: **много unit**, **достаточно integration**, **минимум E2E на критичные сценарии**.

---

## 50.5. Что именно тестировать в фронтенде (если не хочется тратить жизнь зря)

Ставь тест там, где у регресса будет цена. Обычно это:

- **бизнес-правила**: расчёты, ограничения, форматирование, скрытые условия;
- **критичные формы**: регистрация, оплата, создание заказа, любые «точки денег»;
- **границы UX**: loading/error/empty state, ошибки валидации, запретные состояния;
- **интеграции**: авторизация, роли, доступы, обработка ошибок от API.

А вот что часто не нужно тестировать автотестами:

- верстку “пиксель в пиксель”;
- сторонние библиотеки “на доверии” (их тестируют авторы библиотек);
- мелкие декоративные компоненты без поведения.

---

## 50.6. TDD: когда помогает, а когда раздражает

TDD — это цикл:

1. **Red** — пишем тест на поведение, которого ещё нет (он падает).
2. **Green** — делаем минимальную реализацию, чтобы тест прошёл.
3. **Refactor** — приводим код в порядок, не меняя поведение.

TDD особенно полезен там, где вы заранее хотите “зацементировать” договорённости:

- сложная логика;
- спорные кейсы;
- код, который будет жить долго и часто меняться.

Но если вы “нащупываете UI” или экспериментируете с дизайном, TDD может замедлять. Это нормально. TDD — инструмент, а не режим “навсегда”.

---

## 50.7. Как писать тесты, которые приятно поддерживать

### Думай сценариями

Хорошее имя теста читается как фраза:

- «показывает ошибку, если email некорректный»;
- «не отправляет форму, пока пользователь не согласился с условиями»;
- «после успешного сохранения показывает уведомление и очищает форму».

Если тест невозможно назвать нормально, обычно это знак: сценарий размыт или тест пытается проверить слишком много сразу.

### Держи структуру простой

Почти любой тест можно разложить на:

- **Arrange**: подготовили данные/состояние,
- **Act**: сделали действие,
- **Assert**: проверили результат.

Если тест превращается в «роман на 200 строк», чаще всего виноват не тест, а слишком большой компонент/непонятные границы ответственности.

---

## 50.8. Flaky-тесты: как не потерять доверие к тестам

Flaky-тест — это когда «то проходит, то падает». И это хуже отсутствия тестов, потому что команда перестаёт верить результатам.

Типовые причины:

- ожидания через таймауты вместо ожидания события;
- общие тестовые данные (тесты влияют друг на друга);
- зависимость от порядка выполнения;
- асинхронщина без явных ожиданий.

Правило простое: **flaky-тест — это баг**, его нужно чинить, а не “перезапускать CI до победы”.

---

## 50.9. Как внедрять тесты на проекте, где их почти нет

Рабочий путь без героизма:

- начни с **критичных сценариев**, где регресс стоит денег/репутации;
- добавляй тест при **каждом багфиксе** (идеальная точка: ты уже понял проблему);
- новый код — с тестом (пусть минимальным, но чтобы привычка закрепилась);
- рефакторинг без тестов опаснее: сначала стабилизируй поведение, потом переписывай.

Так тесты растут вместе с продуктом и не выглядят навязанной бюрократией.

---

## 50.10. Тесты в CI: что важно, чтобы это работало

CI должен давать два ощущения:

- **быстро** (иначе никто не ждёт и начинают “обходить” процесс);
- **надёжно** (иначе никто не верит).

Практические ориентиры:

- unit/integration — быстрый прогон на каждый PR;
- E2E — отдельным джобом или перед релизом (в зависимости от проекта);
- если тесты становятся медленными — это сигнал улучшать стратегию, а не «терпеть».

Если после этой главы у тебя осталось ощущение «тесты — это про спокойствие», значит мы попали в цель.
