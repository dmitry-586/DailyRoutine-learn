# Глава 8. Web Vitals и быстрая загрузка: что важно знать

Про производительность на собеседованиях обычно спрашивают не “как устроен каждый API”, а **как мыслить**: какие метрики описывают пользовательское восприятие, что чаще всего их портит, и какие действия дают максимальный эффект. В этой главе — короткий, но полноценный минимум.

---

## 8.1. Что происходит при загрузке страницы

Грубо можно представить загрузку так:

- Браузер получает HTML и строит DOM.
- Загружает CSS/JS/картинки, применяет стили.
- Делает layout/paint и показывает контент.
- После этого страница “оживает”: обработчики, гидратация, тяжелый JS и т.д.

Два события, которые важно различать:

- `DOMContentLoaded`: DOM уже построен, но не все ресурсы обязаны быть загружены.
- `load`: загружены ресурсы (картинки, CSS и т.п.), страница “полностью” готова.

Этого понимания обычно достаточно, чтобы объяснить, почему “DOM готов” ещё не означает “пользователю быстро и удобно”.

---

## 8.2. Core Web Vitals — 4 метрики, которые надо уметь объяснить

**TTFB (Time To First Byte)** — время до первого байта ответа. Сильно зависит от сервера, сети, кэша, близости контента (CDN).

**LCP (Largest Contentful Paint)** — когда показался главный (самый крупный) кусок контента. Это то, что пользователь воспринимает как “страница загрузилась”.

**CLS (Cumulative Layout Shift)** — насколько “прыгает” вёрстка во время загрузки. Даже если всё быстро, прыжки создают ощущение “сайт лагает”.

**INP (Interaction to Next Paint)** — насколько быстро интерфейс реагирует на действие пользователя (клик/ввод) до следующей отрисовки. Упирается в нагрузку на главный поток.

Про точные пороги можно помнить примерно: **хорошо — когда это “сотни миллисекунд” (TTFB/INP), “пара секунд” (LCP) и “почти ноль” (CLS)**. На практике важнее уметь назвать причины и способы улучшения.

---

## 8.3. Что чаще всего ухудшает метрики (и что делать в первую очередь)

### TTFB: “долго отвечает сервер”

Типовые причины: нет кэширования, тяжелая логика на запрос, медленная БД, нет CDN для статики.

Что делать:

- добавить кэш (CDN/edge/HTTP-кэш/серверный кэш),
- оптимизировать серверную работу (дорогие запросы, холодные старты),
- держать статические ресурсы ближе к пользователю (CDN).

### LCP: “главный контент появляется поздно”

Типовые причины: тяжелые изображения/видео, блокирующий CSS/JS, слишком много критичного JavaScript.

Что делать:

- оптимизировать “герой”-изображение (размер, формат, приоритет загрузки),
- уменьшить блокирующие ресурсы (разделить код, убрать лишнее из первого экрана),
- сделать критический контент доступным раньше (SSR/streaming там, где уместно).

### CLS: “всё прыгает”

Типовые причины: изображения без заранее известного размера, динамически вставляемые блоки, шрифты, которые меняют размеры текста.

Что делать:

- всегда **резервировать место** под медиа и виджеты,
- не вставлять контент “над” уже отрисованным без резерва,
- аккуратно работать со шрифтами (чтобы замена не ломала layout).

### INP: “кликнул — реакция с задержкой”

Типовые причины: большой JS, тяжёлые обработчики, лишние перерисовки, долгие синхронные вычисления в main thread.

Что делать:

- уменьшить и отложить JS (code splitting, lazy/dynamic import),
- упростить обработчики событий, выносить тяжёлое из main thread,
- следить за рендерами (не делать лишнюю работу на взаимодействия).

---

## 8.4. Preload vs Prefetch — коротко и по делу

Иногда важно “подсказать” браузеру про ресурсы:

- `preload`: **точно нужно сейчас** (критично для текущей страницы), высокий приоритет.
- `prefetch`: **может понадобиться потом** (например, следующая страница), низкий приоритет.

Идея простая: preload помогает первому экрану, prefetch — будущей навигации.

---

## 8.5. Как измеряют в реальности

На практике достаточно знать три уровня:

- локально: Chrome DevTools Performance,
- автоматом: Lighthouse,
- в проде: сбор реальных метрик (RUM) и анализ по реальным пользователям.

Важно: **лабораторные замеры полезны для воспроизводимости, но окончательная правда — в данных продакшена**.

---

## Вопросы на собеседовании

1. Что такое Web Vitals и зачем они?  
   Это набор метрик, которые описывают воспринимаемую скорость и качество загрузки/интерактива. Они помогают приоритизировать работу: где проблема — в серверном ответе, в первом экране, в стабильности layout или в интерактивности. Важно уметь связать метрику с причиной и действием.

2. Чем отличается `DOMContentLoaded` от `load`?  
   `DOMContentLoaded` означает, что HTML распарсен и DOM построен — можно работать с элементами, но ресурсы ещё могут грузиться. `load` срабатывает, когда загрузились все ресурсы страницы. Это объясняет, почему “код уже работает”, но пользователь может видеть незагруженные изображения.

3. Что такое LCP/CLS/INP и как их улучшать в общих чертах?  
   LCP — момент появления основного контента первого экрана; улучшается оптимизацией изображений и уменьшением блокирующих ресурсов. CLS — “прыжки” интерфейса; лечится резервированием места под медиа и аккуратной подгрузкой контента. INP — отзывчивость на действия; улучшается уменьшением работы на main thread и оптимизацией обработчиков.

4. Что измеряет TTFB и почему он может быть плохим даже на “быстром” фронтенде?  
   TTFB — время до первого байта ответа, зависит от сервера, сети и кэша. Даже оптимизированная страница будет “начинать” поздно, если сервер долго думает или контент далеко от пользователя. Решение — кэширование, CDN и оптимизация серверной части.
